name: Release â€” publish to npm (manual)

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Choose release type (auto-increases version)'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      branch:
        description: 'Branch to use for release'
        required: false
        default: 'master'
        type: string
      dry_run:
        description: 'Dry run mode: test without publishing'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.inputs.branch }}

      - name: Pull latest changes
        run: |
          git pull origin ${{ github.event.inputs.branch }}
          CURRENT_VERSION=$(node -p 'require("./package.json").version')
          echo "ðŸ“¦ Current version: $CURRENT_VERSION"

      - name: Check working directory is clean
        run: |
          if [[ -n $(git status -s) ]]; then
            echo "âŒ Error: Working directory is not clean"
            echo ""
            git status
            exit 1
          fi
          echo "âœ… Working directory is clean"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org/

      - name: Configure npm auth
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ -z "$NPM_TOKEN" ]; then
            echo "âŒ Error: NPM_TOKEN secret is not set"
            exit 1
          fi
          printf "//registry.npmjs.org/:_authToken=%s\n" "$NPM_TOKEN" > ~/.npmrc

      - name: Install dependencies
        run: |
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi

      - name: Run tests
        run: |
          echo "ðŸ§ª Running tests before release..."
          npm run lint || echo "âš ï¸ Lint not configured"
          npm test || echo "âš ï¸ Tests not configured"
          echo "âœ… Pre-release checks completed!"

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Configure remote with authentication
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

      - name: Calculate next version
        id: version
        run: |
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"
          CURRENT=$(node -p 'require("./package.json").version')
          
          # Calculate next version using Node.js
          if [ "$RELEASE_TYPE" = "major" ]; then
            NEXT=$(node -p "const v = require('./package.json').version.split('.'); [parseInt(v[0])+1, 0, 0].join('.')")
          elif [ "$RELEASE_TYPE" = "minor" ]; then
            NEXT=$(node -p "const v = require('./package.json').version.split('.'); [v[0], parseInt(v[1])+1, 0].join('.')")
          else
            NEXT=$(node -p "const v = require('./package.json').version.split('.'); [v[0], v[1], parseInt(v[2])+1].join('.')")
          fi
          
          echo "CURRENT_VERSION=$CURRENT" >> $GITHUB_OUTPUT
          echo "NEXT_VERSION=$NEXT" >> $GITHUB_OUTPUT
          echo "RELEASE_TYPE=$RELEASE_TYPE" >> $GITHUB_OUTPUT
          echo ""
          echo "ðŸ“¦ Release plan:"
          echo "   Type: $RELEASE_TYPE"
          echo "   Current: $CURRENT"
          echo "   Next: $NEXT"
          echo ""

      - name: Check version doesn't exist on npm
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          PACKAGE_NAME=$(node -p 'require("./package.json").name')
          NEXT_VERSION="${{ steps.version.outputs.NEXT_VERSION }}"
          
          echo "Checking if version $NEXT_VERSION exists on npm..."
          
          if npm view ${PACKAGE_NAME}@${NEXT_VERSION} version 2>/dev/null; then
            echo "âŒ Error: Version ${NEXT_VERSION} already exists on npm"
            echo "Please choose a different release type or manually bump the version."
            exit 1
          fi
          
          echo "âœ… Version ${NEXT_VERSION} is available"

      - name: Dry-run release
        if: ${{ github.event.inputs.dry_run == 'true' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ§ª DRY RUN MODE"
          echo ""
          echo "Would release version: ${{ steps.version.outputs.NEXT_VERSION }}"
          echo ""
          
          # Test version bump
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"
          npm version $RELEASE_TYPE --no-git-tag-version
          
          NEW_VERSION=$(node -p 'require("./package.json").version')
          echo "âœ… Version would be bumped to: $NEW_VERSION"
          
          # Validate package can be built and packed
          npm run build || echo "âš ï¸ Build step not found or failed"
          npm pack --dry-run
          
          echo ""
          echo "âœ… Dry-run validation completed!"
          echo "No changes were made to the repository or npm."
          
          # Revert changes
          git checkout -- package.json package-lock.json 2>/dev/null || git checkout -- package.json

      - name: Bump version and commit
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"
          
          echo "ðŸ“Œ Bumping $RELEASE_TYPE version..."
          npm version $RELEASE_TYPE --no-git-tag-version
          
          NEW_VERSION=$(node -p 'require("./package.json").version')
          echo "âœ… Version updated to: $NEW_VERSION"
          
          # Commit the version bump
          git add package.json package-lock.json 2>/dev/null || git add package.json
          git commit -m "chore: bump version to $NEW_VERSION"
          
          echo "âœ… Version bump committed locally"
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT
        id: bump

      - name: Build project
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          echo "ðŸ”¨ Building project..."
          npm run build || echo "âš ï¸ Build step not found or failed"
          echo "âœ… Build completed"

      - name: Run release (without version bump)
        if: ${{ github.event.inputs.dry_run != 'true' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸš€ Starting release process..."
          echo ""
          
          CURRENT_VERSION=$(node -p 'require("./package.json").version')
          echo "Version to release: $CURRENT_VERSION"
          echo ""
          
          # Check if n8n-node release supports --no-increment
          # If not, we'll use npx release-it directly
          
          if npm run release -- --help 2>&1 | grep -q "no-increment"; then
            echo "Using n8n-node release with --no-increment"
            npm run release -- --no-increment --ci
          else
            echo "Using release-it directly (n8n-node doesn't support --no-increment)"
            
            # Create a temporary .release-it.json if it doesn't exist
            if [ ! -f ".release-it.json" ]; then
              echo '{
                "git": {
                  "commitMessage": "chore: release v${version}",
                  "tagName": "${version}",
                  "requireCleanWorkingDir": false,
                  "requireUpstream": false
                },
                "npm": {
                  "publish": true
                },
                "github": {
                  "release": true
                },
                "hooks": {
                  "after:bump": "npm run build || echo \"No build step\""
                }
              }' > .release-it.json
            fi
            
            # Run release-it without version increment (version already bumped)
            npx release-it --no-increment --ci
          fi
          
          echo ""
          echo "âœ… Release completed!"

      - name: Verify release
        if: ${{ github.event.inputs.dry_run != 'true' && success() }}
        run: |
          # Update local repo after release
          git pull origin ${{ github.event.inputs.branch }} || true
          
          FINAL_VERSION=$(node -p 'require("./package.json").version')
          EXPECTED_VERSION="${{ steps.version.outputs.NEXT_VERSION }}"
          
          echo "ðŸ“¦ Published version: $FINAL_VERSION"
          
          if [ "$FINAL_VERSION" = "$EXPECTED_VERSION" ]; then
            echo "âœ… Version matches expected: $EXPECTED_VERSION"
          else
            echo "âš ï¸ Warning: Version is $FINAL_VERSION (expected $EXPECTED_VERSION)"
            echo "This might indicate an issue with the release process"
          fi
          
          # Verify on npm
          PACKAGE_NAME=$(node -p 'require("./package.json").name')
          echo ""
          echo "Verifying package on npm..."
          
          # Wait a bit for npm to update
          sleep 5
          
          if npm view ${PACKAGE_NAME}@${FINAL_VERSION} version 2>/dev/null; then
            echo "âœ… Package successfully published to npm!"
          else
            echo "âš ï¸ Package not found on npm yet (may take a few moments to propagate)"
          fi
          
          # Save for summary step
          echo "FINAL_VERSION=$FINAL_VERSION" >> $GITHUB_OUTPUT
        id: verify

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.npmrc || true
          rm -f .release-it.json.tmp || true

      - name: Summary
        if: always()
        run: |
          DRY_RUN="${{ github.event.inputs.dry_run }}"
          JOB_STATUS="${{ job.status }}"
          
          if [ "$DRY_RUN" = "true" ]; then
            echo "# ðŸ§ª Dry Run Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "$JOB_STATUS" = "success" ]; then
              echo "âœ… All checks passed!" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ Validation failed - see logs above" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| | |" >> $GITHUB_STEP_SUMMARY
            echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŽ¯ Release type | \`${{ github.event.inputs.release_type }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“¦ Current version | \`${{ steps.version.outputs.CURRENT_VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ”œ Would release | \`${{ steps.version.outputs.NEXT_VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŒ¿ Branch | \`${{ github.event.inputs.branch }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **No changes were made to the repository or npm**" >> $GITHUB_STEP_SUMMARY
            
          elif [ "$JOB_STATUS" = "success" ]; then
            VERSION="${{ steps.verify.outputs.FINAL_VERSION }}"
            PACKAGE_NAME=$(node -p 'require("./package.json").name')
            
            echo "# ðŸŽ‰ Release v${VERSION} Published!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| | |" >> $GITHUB_STEP_SUMMARY
            echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“¦ Package | \`${PACKAGE_NAME}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ·ï¸ Version | \`${VERSION}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŽ¯ Release type | \`${{ github.event.inputs.release_type }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“Š Previous | \`${{ steps.version.outputs.CURRENT_VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŒ¿ Branch | \`${{ github.event.inputs.branch }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“¦ [View on npm](https://www.npmjs.com/package/${PACKAGE_NAME}/v/${VERSION})" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ·ï¸ [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/${VERSION})" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“ [Compare changes](https://github.com/${{ github.repository }}/compare/${{ steps.version.outputs.CURRENT_VERSION }}...${VERSION})" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“‹ [View commits](https://github.com/${{ github.repository }}/commits/${VERSION})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“¥ Install" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "npm install ${PACKAGE_NAME}@${VERSION}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
          else
            echo "# âŒ Release Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| | |" >> $GITHUB_STEP_SUMMARY
            echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŽ¯ Release type | \`${{ github.event.inputs.release_type }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“¦ Current version | \`${{ steps.version.outputs.CURRENT_VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ”œ Target version | \`${{ steps.version.outputs.NEXT_VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŒ¿ Branch | \`${{ github.event.inputs.branch }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Check the workflow logs above for error details.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **No changes were published to npm**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Common Issues" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Verify NPM_TOKEN secret is set correctly" >> $GITHUB_STEP_SUMMARY
            echo "- Check if version already exists on npm" >> $GITHUB_STEP_SUMMARY
            echo "- Ensure all tests pass locally" >> $GITHUB_STEP_SUMMARY
            echo "- Verify branch has latest changes" >> $GITHUB_STEP_SUMMARY
          fi
